#Report

### Модель

Рассматривается задача численного моделирования динамики электромагнитного поля и находящихся в нём заряжённых частиц, движущихся в двумерной плоскости.

Будем рассматривать трехмерную область $V$ в виде прямоугольного параллелепипеда
$$ V = \{ (x,y,z) : x_{min} \le x \le x_{max}, \ y_{min} \le y \le y_{max}, \ z = 0 \}; $$
Область $V$ называется *расчётной*.

В каждой точке расчётной области определено *значение электромагнитного поля*, состоящее из двух трехмерных векторов:
* $\vec{E}$ - электрическое поле (3-х мерный вектор);
* $\vec{B}$ - магнитное поле (3-х мерный вектор).

**Заряженные частицы**, движущиеся по расчётной области, определяются следующими параметрами:
* $q$ - заряд (скаляр);
* $m$ - масса (скаляр);
* $w$ - вес частицы - количество частиц в макрочастице (целое число);
* $\vec{r}$ - текущее положение в пространстве (3-х мерный вектор, $z = 0$);
* $\vec{v}$ - текущая скорость (3-х мерный вектор, $z = 0$).

*Макрочастица* - частица, движение которой описывает движение группу частиц, находящихся в непосредственной близости, все частицы $w$ - число частиц в такой группе.

Для представления значений поля в каждой точке пространства область $V$ покрывается равномерной сеткой, содержащей $n_x \times n_y$ узлов (т.е. $(n_x - 1) \times (n_y -1 )$ ячеек). Расстояние между узлами (размеры клетки) равны $\Delta x$ и $\Delta y$:
$$ \Delta x = \dfrac{x_{max} - x_{min}}{n_x}, \ \ \ \Delta y = \dfrac{y_{max} - y_{min}}{n_y}. $$
Каждый узел $u$ сетки содержит следующие значения:
* $\vec{E}_u$ - значение электрического поля в узле (3-х мерный вектор);
* $\vec{B}_u$ - значение магнитного поля в узле (3-х мерный вектор);
* $\vec{J}_u$ - плотность тока, создаваемого движущимися по близости заряжёнными частицами (3-х мерный вектор).

Для определения значений поля в произвольной точке пространства используется *линейная интерполяция* по ближайшим к точке узлам сетки.

Начальные условия:
* Сетка $n_x \times n_y$ , для каждого узла $u$ которой определены начальные значения $\vec{E}_{u_0}, \ \vec{B}_{u_0}, \ \vec{J}_{u_0} = 0$;
* Множество частиц $P$, для каждой из которых заданы значения $q$, $m$, $\vec{r} = \vec{r}_0$ , $\vec{v} = \vec{v}_0$.

### Схема решения

Для решения поставленной задачи используется итерационный процесс, каждый шаг которого состоит из следующих этапов:

1. Обновление значений электромагнитного поля в узлах сетки, путём численного решения уравнений Максвелла по методу *FDTD* (Finite-Difference Time-Domain);

2. Обновление положения и скорости частиц, путём численного решения уравнений движения по схеме Бориса;

3. Взвешивание токов, создаваемых движущимися заряжёнными частицами, и сохранения их значений в узлах сетки.

Производится $N$ итераций с временным шагом $\Delta t$.

#### Численное решение уравнений Максвелла
...

#### Численное решение уравнений движения частиц по схеме Бориса

На каждой итерации симуляции новое положение каждой частицы высчитывается по формуле
$$ \vec{r}_{new} = \vec{r}_{old} + \vec{v}_{new} \ \Delta t, $$
где $\Delta t$ - шаг по времени между итерациями.

Следовательно, на каждой новой итерации необходимо вычислять новую скорость частицы на основании данных с предыдущей итерации и значений поля в местоположении частицы.

В дальнейших вычислениях вместо скорость частицы $\vec{v}$ будет использоваться импульс частицы $\vec{p}$, значения $\vec{v}$ и $\vec{p}$ однозначно связаны соотношением
$$ v = \dfrac{p}{m} \left( 1 + \left( \dfrac{p}{mc} \right)^2 \right)^{-\dfrac{1}{2}}, $$
где $c$ - скорость света в вакууме.

Импульс частицы изменяется под воздействием силы Лоренца в соответствии со вторым законом Ньютона в релятивистской форме:

$$ \begin{cases} \dfrac{\partial \vec{p}}{\partial t} = q \left( \vec{E} + \dfrac{1}{c} \vec{v} \times \vec{B} \right), \\ \dfrac{\partial \vec{r}}{\partial t} = \vec{v} = \vec{p} \cdot \dfrac{1}{m} \left( \sqrt{ 1 + \left( \dfrac{p}{mc} \right)^2} \right) ^{-1}; \end{cases} $$
Пусть:
$$\vec{u} = \vec{p} \cdot \dfrac{1}{mc},$$ $$\gamma = \sqrt{1 + | \ \vec{u} \ |^2 } = \sqrt{1 + u^2},$$ тогда:
$$ \begin{cases} \dfrac{\partial u}{\partial t} = \dfrac{q}{mc} \left( \vec{E} + \dfrac{1}{\gamma} \vec{u} \times \vec{B} \right), \\ \dfrac{\partial r}{\partial t} = \dfrac{c}{\gamma} \vec{u}; \end{cases} $$
К первому уравнению системы применим разностное соотношение:
$$ \vec{u} = \dfrac{\vec{u}_{new} + \vec{u}_{old}}{2}, $$
получим:
$$ \dfrac{\vec{u}_{new} - \vec{u}_{old}}{\Delta t} = \dfrac{q}{mc} \left( \vec{E} + \dfrac{\vec{u}_{new} + \vec{u}_{old}}{2 \gamma_{old}} \times \vec{B} \right); $$
Перейдя к новым переменным
$$\vec{u}^{(-)} = u_{old} + \dfrac{q\Delta t}{2mc} \vec{E}, \ \ \ \vec{u}^{(+)} = u_{new} - \dfrac{q\Delta t}{2mc} \vec{E}, $$
получим:
$$ \dfrac{\vec{u}^{(+)} - \vec{u}^{(-)}}{\Delta t} = \dfrac{q}{2 \gamma_{old} mc} \left( (\vec{u}^{(+)} + \vec{u}^{(-)}) \times \vec{B} \right), $$
где $\vec{u}^{(-)}$ вычисляется по текущим значениям, а $\vec{u}^{(+)}$ является искомой величиной. 
Полученное соотношение представляет собой систему из 3-х линейных уравнений с тремя неизвестными (уравнение и неизвестная для каждой из осей $x,y,z$) и невырожденной матрице. Такая система имеет единственное решение. 

Но на практике решение такой системы является слишком вычислительно сложным методом, поэтому в реальных ситуациях используют **схему Бориса**:

$$ \vec{p}_{new} = mc \ \cdot \ \vec{u}_{new}; $$
$$ \vec{u}_{new} = \vec{u}^{(+)} + \dfrac{q\Delta t}{2mc}; $$
$$ \vec{u}^{(+)} = \vec{u}^{(-)} + \vec{u}^{\ `} \ \times \vec{s};$$
$$ \vec{s} = \vec{t} \cdot \dfrac{2}{1 + | \ \vec{t} \ |^2}; $$
$$ \vec{u}^{\ `} = \vec{u}^{(-)} + \vec{u}^{(-)} \ \times \ \vec{t}; $$
$$
\vec{t} = \vec{B} \cdot \dfrac{q \Delta t }{2 \cdot \gamma_{old} \ \cdot mc }; 
$$
$$
\vec{u}^{(-)} = \vec{u}_{old} + \vec{E} \cdot \dfrac{q \Delta t}{2mc};
$$
$$
\gamma_{old} = \sqrt{1 + | \ \vec{u}_{old} \ |^2 }; 
$$
$$ \vec{u}_{old} = \vec{p}_{old} \cdot \dfrac{1}{mc}. $$
Таким образом, схема Бориса преобразует импульс частицы $\vec{p}_{old}$ с предыдущей итерации в новое значение $\vec{p}_{new}$ - имульс частицы на текущей итерации. Переведя имульс $\vec{p}_{new}$ в скорость $\vec{v}_{new}$ , можем получить новое положение частицы $\vec{r}_{new}$ .

#### Взвешивание токов
...