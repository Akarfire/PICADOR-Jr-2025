#Module 

### Описание модуля

Модуль `Particle Solver` предназначен для:
* Интегрирования уравнений движения частиц по схеме Бориса;
* Обработки перемещения частиц между ячейками сетки частиц (`ParticleGrid`).

### Конфигурация модуля

-
### Реализация

Информация о частице хранится в структуре `Particle`:

```c++
struct Particle
{
    ParticleType type; // Тип частицы: Photon, Proton, Electron, Positron

    size_t weight; // "Вес" / Фактор частицы

    double mass; // Масса частицы

    double charge; // Заряд частицы

    Vector3 location; // Положение частицы

    Vector3 impulse; // Импульс частицы

    bool transferFlag; // Флаг перехода в другую ячейку

    unsigned short int trackingID = 0; // Опциональный идекс отслеживания, необходим для сбора данных о частице
};
```

Метод `onUpdate()`, вызываемый ядром каждую итерацию симуляции, проходит по всем ячейкам сетки частиц, внутри каждой ячейки - по всем частицам. Обновление каждой частицы происходит в следующем порядке:

1. Из предоставляемого ядром контейнера поля берётся значение электромагнитного поля в точке `location` - местоположении частицы;

2. При помощи метода `CalculateNewParticleImpulse` высчитывается новый импульс частицы, который затем преобразуется в скорость для дальнейших вычислений;

3. Происходят проверки на превышение скорости света и на "длинный прыжок" - перелёт частицы дальше чем на одну клетку;
   
4. По полученной на шаге `2` скорости вычисляется новое положение частицы;

5. Происходит проверка на вылет частицы из текущей ячейки: если частицы покинула ячейку, она помечается флагом `transferFlag`.

После первого прохода по всем ячейкам, модуль начинает второй - проход переноса. На этом проходе частицы, помеченные флагом `transferFlag` перекладываются в новые ячейки.


### Тестирование

##### Тест "Релятивистское ускорение в статическом поле"

Дана одна частица с начальными параметрами:
* $q = e^-$ ;
* $m = m_e, \text{ где } m_e \text{ - масса электрона;}$
* $\vec{r} = 0$;
* $\vec{v} = 0$.

В каждой точке пространства электромагнитное поле определено следующими значениями:
* $\vec{E} = (E_0, 0, 0), \ \ \ E_0 = 10$;
* $\vec{B} = 0.$

Производится $N = 2000$ итераций с временным шагом $\Delta t$
$$ \Delta t = \dfrac{mc}{qE_0N}. $$
Полученный результат сравнивается с аналитическим:
$$ \vec{r}_a = \left( \dfrac{mc^2}{qE_0} (\sqrt2 - 1), \ 0, \ 0 \right), \ \ \ \ \ \vec{p_a} = (-1 \cdot mc, \ 0, \ 0). $$
Тест считается пройденным, если абсолютная ошибка по обеим осям координат составляет:
* Для $\vec{r}$ - не более $0.1$;
* Для $\vec{v}$ - не более $10^{-25}$;

С уменьшением временного шага $\Delta t$ и соответствующим ростом числа итераций $N$ ожидается линейное уменьшение абсолютной ошибки - схождение метода к правильному ответу.

**График сходимости ошибки**

![](../Images/BorisA_L.png)
*Горизонталь: Временной Шаг (в сторону уменьшения)*
*Вертикаль: Абсолютная ошибка;*

Результат соответствует ожидаемому - ошибка уменьшается линейно.


##### Тест Осцилляция в статическом поле

Дана одна частица с начальными параметрами:
* $q = e^-$ ;
* $m = m_e, \text{ где } m_e \text{ - масса электрона;}$
* $\vec{r} = 0$;
* $\vec{p} = (p_0, 0, 0), \ \ \ p_0 = 10^{-20}$.

В каждой точке пространства электромагнитное поле определено следующими значениями:
* $\vec{E} = 0$;
* $\vec{B} = (B_0, 0, 0), \ \ \ B_0 = 100$

Производится $N = 700$ итераций с временным шагом $\Delta t$
$$ \Delta t = \dfrac{\pi mc}{|q|B_0N} \sqrt{1 + \left( \dfrac{p_0}{mc} \right)^2}. $$
Полученный результат сравнивается с аналитическим:
$$ \vec{r}_a = \left(0, \ -\dfrac{2p_0c}{qB_0}, \ 0 \right), \ \ \ \ \ \vec{p_a} = (-p_0, \ 0, \ 0). $$
Тест считается пройденным, если абсолютная ошибка по обеим осям координат составляет:
* Для $\vec{r}$ - не более $0.1$;
* Для $\vec{v}$ - не более 1e-25;

С уменьшением временного шага $\Delta t$ и соответствующим ростом числа итераций $N$ ожидается линейное уменьшение абсолютной ошибки - схождение метода к правильному ответу.

**График сходимости ошибки**

![](../Images/BorisO_L.png)
*Горизонталь: Временной Шаг (в сторону уменьшения)*
*Вертикаль: Абсолютная ошибка;*

Результат соответствует ожидаемому - ошибка уменьшается линейно.

### Ссылки:
* [Particle](../Basic/Particle.md)
* [Particle Grid](../Basic/Particle%20Grid.md)
* [Module](../Basic/Module.md)
* [Boris Trajectory Experiment](../Experiments/Boris%20Trajectory%20Experiment.md)
* [PIC Method](../Report/PIC%20Method.md)