#Module

### Описание модуля

Модуль `ParticleGenerator` предназначен для создания и начального распределения частиц по расчётной области (далее - генерации).


### Конфигурация модуля

В конструктор модуля `ParticleGenerator` необходимо подать целое число `seed`, на основании которого будут генерироваться псевдослучайные значения.

Параметры создаваемых частиц определяются набором **профилей генерации** (`ParticleGenerationProfile`). Каждый профиль определяет правила генерации одного типа частиц и указывает:

* `sampleParticle` - частица-образец от которой будут копироваться параметры `particleType` - тип частицы, `mass` - масса и `charge` - заряд;

* `particleDensityFunction`- $d(r)$ - функция плотности распределения частиц, имеющая следующий прототип: `double f(Vector3 location)` (принимает вектор положения в пространстве, возвращает плотность);

* `temperatureFunction`- $t(r)$ - функция температуры частиц. Температура влияет на среднее квадратическое отклонение начальной скорости частиц. Функция имеет следующий прототип: `double f(Vector3 location)`(принимает вектор положения в пространстве, возвращает температуру);

* `initialImpulseFunction`- $p(r)$ - функция начального импульса частиц, имеющая следующий прототип: `Vector3 f(Vector3 location)` (принимает вектор положения в пространстве, возвращает значение начального импульса);

* `particleFactorFunction`- $f(r)$ - функция веса $w$ частиц, имеющая следующий прототип: `size_t f(Vector3 location)` (принимает вектор положения в пространстве, возвращает значение веса частицы).

Профили генерации можно добавлять с помощью метода `addGenerationProfile`.


### Реализация

Метод `onBegin()`, вызываемый ядром перед началом симуляции, проходит по всем ячейкам основной области сетки частиц и вызывает для них метод `generateParticlesForCell`. Указанный метод проходит по каждому профилю генерации и создаёт частицы по следующему принципу:

1. Количество частиц в ячейке находится по формуле $$ d(r) \ \cdot \ \Delta x \ \cdot \ \Delta y \ \cdot \ \Delta z \ / \ f(r), $$ где $d()$ - функция плотности частиц, $\Delta x$ и $\Delta y$ - размеры ячейки, $\Delta z = \Delta y$, $f(r)$ - функция веса частицы, а $r$ - координаты центра ячейки.

2. Положение каждой частицы внутри ячейки выбирается случайным образом в соответствии с равномерным распределением.

3. Начальная скорость частицы задаётся случайным образом в соответсвии с  нормальным распределением, близким к распределению Максвелла. Параметры распределения: $$ \mu = p\_to\_v( \ p(r), \ m \ ), \ \ \ \sigma = \sqrt{ \dfrac{t(r)}{m}},$$ где $p\_to\_v$ - функция, преобразующая импульс в скорость, $p(r)$ - функция начального импульса частиц, $t(r)$ - функция температуры, $m$ - масса частицы, $r$ - положение частицы.

4. Остальные параметры частицы копируются у частицы-образца, указанной в профиле генерации.


### Тестирование

#### Модульное тестирование

Для модуля `ParticleGenerator` были реализованы следующие модульные тесты:

* Корректность равномерного распределения с единственным профилем генерации;
* Корректность для произвольного распределения с единственным профилем генерации;
* Проверка отсутвия сгенерированных частиц в дополнительных ячейках сетки частиц;
* Корректность постоянного веса частиц;
* Корректность непостоянного веса частиц;
* Проверка: начальные скорости частиц при низкой температуре ($10^{-40}$) должны быть близки к нулю.

#### Проверка начального распределения скоростей

Для проверки совпадения начального распределения с нормальным были построены следующие графики:

![](../Images/Generator_VelocityDistr_X.png)
*Распределение начальных скоростей частиц по оси x*

![](../Images/Generator_VelocityDistr_Y.png.png)
*Распределение начальных скоростей частиц по оси y*

Вид графиков совпадает с ожидаемым.

#### Графики начальных распределений частиц

В качестве эксперимента были построены графики начальных распределений частиц при различных функцих плотности (каждая точка - частица):

$$d(r) = 2$$
![](../Images/Generator_ConstantDistribution.png)

$$ d(r) = (1 - min(1, \ ||(r - (25, \  25, \ 0))|| \ /  \ 25)) \cdot 10) $$
![](../Images/Generator_RadialGradient.png)

$$ d(r) = max(sin(r_x) \cdot 3 + sin(r_y) \cdot 3, \ 0)  $$
![](../Images/Generator_GridLikeDistribution.png)

### Ссылки
* [Particle](../Basic/Particle.md)
* [Particle Grid](../Basic/Particle%20Grid.md)
* [Module](../Basic/Module.md)
* [Particle Generator Experiment](../Experiments/Particle%20Generator%20Experiment.md)